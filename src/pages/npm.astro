---
import Layout from "../layouts/Layout.astro";
---

<Layout registry="npm">
    <div id="content" class="flex-1 p-4 overflow-auto min-w-0">
        <div id="compare-status" class="text-sm text-neutral-700 dark:text-neutral-300 mb-3">
            Loading...
        </div>
        <div id="diff-container" class="hidden">
            <div id="diff-filename" class="text-sm font-semibold text-neutral-900 dark:text-white"></div>
            <pre
                id="diff-output"
                class="mt-2 bg-neutral-50 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg p-3 text-xs text-neutral-900 dark:text-neutral-100 overflow-auto whitespace-pre-wrap"
            ></pre>
        </div>
    </div>
</Layout>

<script>
    const statusEl = document.getElementById('compare-status');
    const diffContainer = document.getElementById('diff-container');
    const diffFilename = document.getElementById('diff-filename');
    const diffOutput = document.getElementById('diff-output');

    function resetDiff() {
        diffContainer?.classList.add('hidden');
        if (diffFilename) diffFilename.textContent = "";
        if (diffOutput) diffOutput.innerHTML = "";
    }

    function escapeHtml(value: string) {
        return value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function renderDiffHtml(diff: string, isDiff = true) {
        return diff.split('\n').map((line) => {
            let lineClass: string;
            if (isDiff) {
                if (line.startsWith('+')) {
                    lineClass = 'bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300';
                } else if (line.startsWith('-')) {
                    lineClass = 'bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300';
                } else if (line.startsWith('@@') || line.startsWith('---') || line.startsWith('+++')) {
                    lineClass = 'bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-200';
                } else {
                    lineClass = 'text-neutral-800 dark:text-neutral-100';
                }
            } else {
                lineClass = 'text-neutral-800 dark:text-neutral-100';
            }

            return `<div class="diff-line ${lineClass}">${escapeHtml(line)}</div>`;
        }).join('');
    }

    function showDiff(filename: string, diff: string, isDiff = true) {
        if (!diffContainer || !diffFilename || !diffOutput) return;
        diffContainer.classList.remove('hidden');
        diffFilename.textContent = filename;
        diffOutput.innerHTML = renderDiffHtml(diff, isDiff);
    }

    function handleUrlChange() {
        const pathParts = window.location.pathname.split('/').filter(Boolean);
        let pkg: string;
        let from: string;
        let to: string;

        if (pathParts[1]?.startsWith('@')) {
            pkg = `${pathParts[1]}/${pathParts[2]}`;
            from = pathParts[3];
            to = pathParts[4];
        } else {
            pkg = pathParts[1];
            from = pathParts[2];
            to = pathParts[3];
        }

        if (statusEl) {
            if (pkg && from && to) {
                statusEl.textContent = `Comparing ${pkg}: ${from} -> ${to}. Select a file from the tree to view changes.`;
                resetDiff();
            } else {
                statusEl.textContent = 'Select a package and versions to compare';
                resetDiff();
            }
        }
    }

    interface FileDiffDetail {
        filename: string;
        diff: string;
        isDiff: boolean;
    }

    window.addEventListener('popstate', handleUrlChange);
    window.addEventListener('start-diff', handleUrlChange);
    window.addEventListener('file-diff', (e) => {
        const customEvent = e as CustomEvent<FileDiffDetail>;
        const detail = customEvent.detail;
        if (detail && detail.filename && detail.diff !== undefined) {
            showDiff(detail.filename, detail.diff, detail.isDiff);
        }
    });

    // Initial load
    handleUrlChange();
</script>
