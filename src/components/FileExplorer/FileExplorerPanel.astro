---
import ResizerHandle from "./ResizerHandle.astro";
import TreeFilter from "./TreeFilter.astro";
import TreeList from "./TreeList.astro";
---

<script is:inline>
	(() => {
		const storageKey = "tree_panel_width";
		const defaultWidth = 320;
		const minWidth = 220;
		const maxWidth = 640;
		const savedWidth = localStorage.getItem(storageKey);
		const parsed = savedWidth ? Number.parseInt(savedWidth, 10) : NaN;
		const width = Number.isNaN(parsed)
			? defaultWidth
			: Math.min(maxWidth, Math.max(minWidth, parsed));
		document.documentElement.style.setProperty(
			"--tree-panel-width",
			`${width}px`,
		);
	})();
</script>

<div class="bg-neutral-50 dark:bg-neutral-950 h-full" id="tree-root">
	<div
		class="h-full bg-white dark:bg-neutral-900 border-r border-neutral-200 dark:border-neutral-800 p-4 relative flex flex-col"
		id="tree-panel"
		style="width: var(--tree-panel-width, 320px);"
	>
		<TreeFilter/>
		<TreeList/>
		<ResizerHandle/>
	</div>
</div>

<script>
	import { escapeHTML } from "../../utils/dom.ts";
	import { parseUrl } from "../../utils/urlParser";
	import type { DiffFileEntry, DiffStatus } from "../../workers/diff.worker";

	const STORAGE_KEY = "tree_panel_width";
	const MODIFIED_STORAGE_KEY = "tree_show_only_modified";
	const DEFAULT_WIDTH = 320;
	const MIN_WIDTH = 220;
	const MAX_WIDTH = 640;

	let panel: HTMLElement | null = null;
	let filterInput: HTMLInputElement | null = null;
	let toggleModifiedBtn: HTMLElement | null = null;
	let treeContent: HTMLElement | null = null;
	let resizer: HTMLElement | null = null;
	let currentFilter = "";
	let showOnlyModified = true;
	let expandedKeys = new Set<string>();
	let collapsedKeys = new Set<string>();
	let width = DEFAULT_WIDTH;
	let diffData: DiffFileEntry | null = null;
	let diffWorker: Worker | null = null;
	let selectedFilePath = "";

	// SVGs
	const chevronRight = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-neutral-600 dark:text-neutral-400 shrink-0"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
	const chevronDown = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-neutral-600 dark:text-neutral-400 shrink-0"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
	const folderIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-500 dark:text-blue-400 shrink-0"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>`;
	const folderOpenIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-blue-500 dark:text-blue-400 shrink-0"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"></path></svg>`;
	const fileIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-neutral-500 dark:text-neutral-400 shrink-0"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>`;

	function getStatusColor(status: DiffStatus) {
		switch (status) {
			case "added":
				return "text-green-600 dark:text-green-400";
			case "removed":
				return "text-red-600 dark:text-red-400";
			case "modified":
			case "renamed":
				return "text-amber-600 dark:text-amber-400";
			default:
				return "text-neutral-800 dark:text-neutral-200";
		}
	}

	function getStatusBadge(item: DiffFileEntry) {
		if (item.status === "unchanged") return "";

		let badges = "";
		if (item.status === "renamed") {
			badges += `<span class="text-[10px] font-bold bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 px-1 rounded mr-1 shrink-0">RENAMED</span>`;
		}

		const added = item.added || 0;
		const removed = item.removed || 0;

		if (added > 0) {
			badges += `<span class="text-[12px] font-bold text-green-600 dark:text-green-400 px-1 shrink-0">+${added}</span>`;
		}
		if (removed > 0) {
			badges += `<span class="text-[12px] font-bold text-red-600 dark:text-red-400 px-1 shrink-0">-${removed}</span>`;
		}

		return badges;
	}

	function findNode(root: DiffFileEntry, path: string): DiffFileEntry | null {
		if (root.path === path) return root;
		if (root.children) {
			for (const child of root.children) {
				const found = findNode(child, path);
				if (found) return found;
			}
		}
		return null;
	}

	// Initialization
	function init() {
		panel = document.getElementById("tree-panel");
		filterInput = document.getElementById("tree-filter") as HTMLInputElement;
		toggleModifiedBtn = document.getElementById("toggle-modified");
		treeContent = document.getElementById("tree-content");
		resizer = document.getElementById("tree-resizer");

		if (
			!panel ||
			!filterInput ||
			!toggleModifiedBtn ||
			!treeContent ||
			!resizer
		)
			return;

		const savedWidth = localStorage.getItem(STORAGE_KEY);
		if (savedWidth && panel) {
			const parsed = parseInt(savedWidth, 10);
			if (!Number.isNaN(parsed)) {
				width = Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, parsed));
				panel.style.width = `${width}px`;
			}
		}

		const savedShowOnlyModified = localStorage.getItem(MODIFIED_STORAGE_KEY);
		if (savedShowOnlyModified !== null) {
			showOnlyModified = savedShowOnlyModified !== "false";
		}

		if (diffWorker) {
			diffWorker.terminate();
		}

		if (!showOnlyModified && toggleModifiedBtn) {
			toggleModifiedBtn.classList.add(
				"bg-blue-50",
				"text-blue-600",
				"border-blue-200",
				"dark:bg-blue-900/20",
				"dark:text-blue-400",
				"dark:border-blue-800",
			);
		} else if (toggleModifiedBtn) {
			toggleModifiedBtn.classList.add(
				"text-neutral-400",
				"dark:text-neutral-500",
			);
		}

		diffWorker = new Worker(
			new URL("../../workers/diff.worker.ts", import.meta.url),
			{ type: "module" },
		);
		diffWorker.onmessage = (e) => {
			if (e.data.type === "diff-result") {
				if (e.data.filename) {
					window.dispatchEvent(
						new CustomEvent("file-diff", {
							detail: {
								filename: e.data.filename,
								diff: e.data.data,
								isDiff: e.data.isDiff,
							},
						}),
					);
				} else {
					expandedKeys = new Set();
					diffData = e.data.data;
					renderTree();

					const state = parseUrl(window.location.pathname);
					if (state.file) {
						selectedFilePath = state.file;
						const item = diffData ? findNode(diffData, state.file) : null;
						if (diffWorker) {
							diffWorker.postMessage({
								type: "get-diff",
								filename: state.file,
								oldPath: item?.oldPath,
							});
							// Expand folders
							const parts = state.file.split("/");
							let current = "";
							for (let i = 0; i < parts.length - 1; i++) {
								current += (current ? "/" : "") + parts[i];
								expandedKeys.add(current);
							}
							renderTree();
						}
					}
				}
			} else if (e.data.type === "error") {
				console.error("Worker error:", e.data.error);
				if (treeContent)
					treeContent.innerHTML = `<div class="p-4 text-red-500">Error: ${escapeHTML(e.data.error)}</div>`;
			}
		};

		filterInput?.addEventListener("input", (e) => {
			currentFilter = (e.target as HTMLInputElement).value.toLowerCase();
			collapsedKeys.clear();
			renderTree();
		});

		toggleModifiedBtn?.addEventListener("click", () => {
			if (!toggleModifiedBtn) return;
			showOnlyModified = !showOnlyModified;
			localStorage.setItem(
				MODIFIED_STORAGE_KEY,
				showOnlyModified.toString(),
			);
			collapsedKeys.clear();
			if (!showOnlyModified) {
				toggleModifiedBtn.classList.add(
					"bg-blue-50",
					"text-blue-600",
					"border-blue-200",
					"dark:bg-blue-900/20",
					"dark:text-blue-400",
					"dark:border-blue-800",
				);
				toggleModifiedBtn.classList.remove(
					"text-neutral-400",
					"dark:text-neutral-500",
				);
			} else {
				toggleModifiedBtn.classList.remove(
					"bg-blue-50",
					"text-blue-600",
					"border-blue-200",
					"dark:bg-blue-900/20",
					"dark:text-blue-400",
					"dark:border-blue-800",
				);
				toggleModifiedBtn.classList.add(
					"text-neutral-400",
					"dark:text-neutral-500",
				);
			}
			renderTree();
		});

		resizer?.addEventListener("mousedown", (e) => {
			e.preventDefault();
			const startX = e.clientX;
			const startWidth = width;

			const onMouseMove = (moveEvent: MouseEvent) => {
				const delta = moveEvent.clientX - startX;
				width = Math.min(MAX_WIDTH, Math.max(MIN_WIDTH, startWidth + delta));
				if (panel) panel.style.width = `${width}px`;
				localStorage.setItem(STORAGE_KEY, width.toString());
			};

			const onMouseUp = () => {
				window.removeEventListener("mousemove", onMouseMove);
				window.removeEventListener("mouseup", onMouseUp);
			};

			window.addEventListener("mousemove", onMouseMove);
			window.addEventListener("mouseup", onMouseUp);
		});
	}

	interface StartDiffDetail {
		registry: string;
		pkg: string;
		from: string;
		to: string;
	}

	window.addEventListener("start-diff", (e) => {
		const customEvent = e as CustomEvent<StartDiffDetail>;
		const detail = customEvent.detail;
		const { pkg, from, to } = detail;
		const state = parseUrl(window.location.pathname);
		const registry = detail.registry || state.registry;
		if (pkg && from && to && diffWorker) {
			if (treeContent)
				treeContent.innerHTML =
					'<div class="p-4 text-neutral-500">Computing diff...</div>';
			diffWorker.postMessage({ type: "start-diff", registry, pkg, from, to });
		}
	});

	window.addEventListener("prefetch-diff", (e) => {
		const customEvent = e as CustomEvent<StartDiffDetail>;
		const detail = customEvent.detail;
		const { pkg, from, to } = detail;
		const state = parseUrl(window.location.pathname);
		const registry = detail.registry || state.registry;
		if (pkg && from && to && diffWorker) {
			diffWorker.postMessage({ type: "prefetch", registry, pkg, from, to });
		}
	});

	window.addEventListener("popstate", () => {
		const state = parseUrl(window.location.pathname);
			if (state.file !== selectedFilePath) {
				selectedFilePath = state.file;
				if (selectedFilePath && diffWorker && diffData) {
					const item = findNode(diffData, selectedFilePath);
					diffWorker.postMessage({
						type: "get-diff",
						filename: selectedFilePath,
						oldPath: item?.oldPath,
					});
				}
				renderTree();
			}
		});

	function updateUrl(file: string) {
		const state = parseUrl(window.location.pathname);
		const pathParts = [
			state.registry,
			state.package,
			state.from,
			state.to,
			file,
		].filter(Boolean);
		const newPath = `/${pathParts.join("/")}`;
		if (window.location.pathname !== newPath) {
			window.history.pushState({}, "", newPath);
		}
	}

	function renderTree() {
		if (!treeContent) return;
		treeContent.innerHTML = "";
		if (!diffData) return;

		const rootChildren = diffData.children || [];
		if (
			expandedKeys.size === 0 &&
			rootChildren.length === 1 &&
			rootChildren[0].type === "directory"
		) {
			expandedKeys.add(rootChildren[0].path);
		}

		// Don't render the root "/" directory itself, just its children
		if (diffData.children) {
			diffData.children.forEach((child) => {
				const node = createNodeElement(child, 0);
				if (node && treeContent) treeContent.appendChild(node);
			});
		}
	}

	function hasVisibleDescendants(item: DiffFileEntry): boolean {
		if (!item.children) return false;

		return item.children.some((child) => {
			const matchesFilter = child.path.toLowerCase().includes(currentFilter);
			const isModified = child.status !== "unchanged";

			// Check if this child itself should be visible
			const isVisible = showOnlyModified
				? isModified && matchesFilter
				: matchesFilter;
			if (isVisible) return true;

			// Recursively check its descendants
			return hasVisibleDescendants(child);
		});
	}

	function createNodeElement(
		item: DiffFileEntry,
		depth: number,
	): HTMLElement | null {
		const name = item.path.split("/").pop() || item.path;
		const hasChildren = item.children && item.children.length > 0;
		const matchesFilter = item.path.toLowerCase().includes(currentFilter);
		const isModified = item.status !== "unchanged";

		const hasVisibleChildren = hasChildren
			? hasVisibleDescendants(item)
			: false;
		const shouldAutoExpand = currentFilter.length > 0 || showOnlyModified;

		let isExpanded = expandedKeys.has(item.path);
		if (
			!isExpanded &&
			!collapsedKeys.has(item.path) &&
			shouldAutoExpand &&
			hasVisibleChildren
		) {
			isExpanded = true;
		}

		// Visibility logic:
		// 1. If filtering by text, item or its descendants must match filter
		if (currentFilter && !matchesFilter && !hasVisibleChildren) {
			return null;
		}

		// 2. If showOnlyModified is active, item or its descendants must be modified
		if (showOnlyModified && !isModified && !hasVisibleChildren) {
			return null;
		}

		const container = document.createElement("div");

		const row = document.createElement("div");
		row.className =
			"flex items-center gap-1 py-1 px-1 pr-3 hover:bg-neutral-100 dark:hover:bg-neutral-800 cursor-pointer select-none rounded group w-full overflow-hidden";
		row.style.paddingLeft = `${depth * 18 + 4}px`;
		row.title =
			item.status === "renamed" ? `Renamed from ${item.oldPath}` : item.path;

		if (item.path === selectedFilePath) {
			row.classList.add("bg-blue-50", "dark:bg-blue-900/20");
		}

		const toggleIcon = document.createElement("span");
		toggleIcon.className = "w-4 flex items-center justify-center";
		if (hasChildren) {
			toggleIcon.innerHTML = isExpanded ? chevronDown : chevronRight;
		}
		row.appendChild(toggleIcon);

		const typeIcon = document.createElement("span");
		typeIcon.className = "w-4 flex items-center justify-center";
		if (item.type === "directory") {
			typeIcon.innerHTML = isExpanded ? folderOpenIcon : folderIcon;
		} else {
			typeIcon.innerHTML = fileIcon;
		}
		row.appendChild(typeIcon);

		const nameSpan = document.createElement("span");
		nameSpan.className = `text-sm truncate min-w-0 flex-1 ${getStatusColor(item.status)}`;
		nameSpan.textContent = name;
		row.appendChild(nameSpan);

		const badgeHtml = getStatusBadge(item);
		if (badgeHtml) {
			row.insertAdjacentHTML("beforeend", badgeHtml);
		}

		row.addEventListener("click", () => {
			if (hasChildren) {
				if (isExpanded) {
					expandedKeys.delete(item.path);
					collapsedKeys.add(item.path);
				} else {
					expandedKeys.add(item.path);
					collapsedKeys.delete(item.path);
				}
				renderTree();
			} else if (item.type === "file" && diffWorker) {
				selectedFilePath = item.path;
				updateUrl(item.path);
				renderTree();

				diffWorker.postMessage({
					type: "get-diff",
					filename: item.path,
					oldPath: item.oldPath,
				});
			}
		});

		container.appendChild(row);

		if (hasChildren && isExpanded && item.children) {
			const childrenContainer = document.createElement("div");
			item.children.forEach((child) => {
				const childEl = createNodeElement(child, depth + 1);
				if (childEl) childrenContainer.appendChild(childEl);
			});
			container.appendChild(childrenContainer);
		}

		return container;
	}

	document.addEventListener("astro:page-load", init);
</script>
