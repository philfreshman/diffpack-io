---
import PackageSearch from "./PackageSearch.astro";
import ThemeIcon from "./ThemeIcon.astro";
import VersionSelectors from "./VersionSelectors.astro";

const { registry } = Astro.props;

const registryGradients: Record<string, string> = {
	npm: "from-red-500/20 via-orange-500/10 to-white-500/20",
	crates: "from-orange-400/20 via-amber-400/10 to-transparent",
};

const currentGradient = registryGradients[registry] || "";
---

<header
	id="header-container"
	data-registry={registry || 'npm'}
	class={`relative w-full flex-none bg-white dark:bg-neutral-950 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-center`}
	style="height: var(--header-height-md)"
>
	<!--{currentGradient && (-->
	<!--		<div class={`absolute inset-0 bg-gradient-to-br ${currentGradient} pointer-events-none`}></div>-->
	<!--)}-->

	<!-- Logo/Title -->
	<div
		class="absolute left-4 top-1/2 -translate-y-1/2 flex justify-center items-center border-2 border-neutral-200 rounded-lg hover:border-3 hover:left-3.75 "
	>
		<a
			href="/"
			class="text-xl font-bold text-neutral-900 dark:text-white font-miriam-libre leading-none -mb-0.5 p-2"
		>
			Diff.io
		</a>
	</div>

	<div class="flex items-end gap-4 w-full max-w-4xl">
		<!-- Package Search Component -->
		<PackageSearch registry={registry}/>

		<!-- Version Selectors Component -->
		<VersionSelectors/>

		<!-- Compare Button -->
		<button
			id="compare-btn"
			disabled
			class="flex-1 self-stretch bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:bg-neutral-300 dark:disabled:bg-neutral-800 disabled:cursor-not-allowed hover:cursor-pointer"
		>
			Compare
		</button>
	</div>

	<ThemeIcon/>
</header>

<script>
	const input = document.getElementById("package-search") as HTMLInputElement;
	const fromSelect = document.getElementById(
		"from-version",
	) as HTMLSelectElement;
	const toSelect = document.getElementById("to-version") as HTMLSelectElement;
	const compareBtn = document.getElementById(
		"compare-btn",
	) as HTMLButtonElement;

	function updateCompareButton() {
		compareBtn.disabled = !input.value || !fromSelect.value || !toSelect.value;
	}

	function getUrlState() {
		const pathParts = window.location.pathname.split("/").filter(Boolean);
		if (pathParts.length === 0)
			return { register: "", package: "", from: "", to: "" };

		const register = pathParts[0];
		let pkg: string;
		let from: string;
		let to: string;

		if (pathParts[1]?.startsWith("@")) {
			pkg = `${pathParts[1]}/${pathParts[2]}`;
			from = pathParts[3] || "";
			to = pathParts[4] || "";
		} else {
			pkg = pathParts[1] || "";
			from = pathParts[2] || "";
			to = pathParts[3] || "";
		}

		return { register, package: pkg, from, to };
	}

	// Compare button handler
	compareBtn.addEventListener("click", () => {
		window.dispatchEvent(
			new CustomEvent("start-diff", {
				detail: {
					pkg: input.value,
					from: fromSelect.value,
					to: toSelect.value,
				},
			}),
		);
	});

	// Update button state on changes
	window.addEventListener("package-selected", updateCompareButton);
	window.addEventListener("versions-loaded", updateCompareButton);
	window.addEventListener("version-changed", updateCompareButton);

	// Initialization - handle URL state on load
	const initialState = getUrlState();
	if (initialState.package) {
		input.value = initialState.package;

		// Trigger package selection which will load versions
		window.dispatchEvent(
			new CustomEvent("package-selected", {
				detail: { name: initialState.package },
			}),
		);

		// After versions are loaded, trigger diff if all params present
		window.addEventListener(
			"versions-loaded",
			() => {
				const state = getUrlState();
				if (state.package && state.from && state.to) {
					window.dispatchEvent(
						new CustomEvent("start-diff", {
							detail: {
								pkg: state.package,
								from: state.from,
								to: state.to,
							},
						}),
					);
				}
			},
			{ once: true },
		);
	}
</script>
