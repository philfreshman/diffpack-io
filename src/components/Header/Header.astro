---
import PackageSearch from "./PackageSearch.astro";
import ThemeIcon from "./ThemeIcon.astro";
import VersionSelectors from "./VersionSelectors.astro";

const { registry } = Astro.props;
---

<header
	id="header-container"
	data-registry={registry || 'npm'}
	class={`relative w-full flex-none bg-white dark:bg-neutral-950 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-center z-10`}
	style="height: var(--header-height-md)"
>
	<div
		class="absolute left-4 top-1/2 -translate-y-1/2 flex justify-center items-center border-2 border-neutral-200 rounded-lg hover:border-3 hover:left-3.75 "
	>
		<a
			href="/"
			class="text-xl font-bold text-neutral-900 dark:text-white font-miriam-libre leading-none -mb-0.5 p-2"
		>
			diffpack
		</a>
	</div>

	<div class="flex items-end gap-4 w-full max-w-4xl">
		<!-- Package Search Component -->
		<PackageSearch registry={registry} />

		<!-- Version Selectors Component -->
		<VersionSelectors />

		<!-- Compare Button -->
		<button
			id="compare-btn"
			disabled
			type="button"
			class="flex-1 self-stretch bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:bg-neutral-300 dark:disabled:bg-neutral-800 disabled:cursor-not-allowed hover:cursor-pointer"
		>
			Compare
		</button>
	</div>

	<ThemeIcon />
</header>

<script>
	import { parseUrl } from "../../utils/urlParser";

	let abortController: AbortController | null = null;

	function initHeader() {
		if (abortController) abortController.abort();
		abortController = new AbortController();
		const { signal } = abortController;

		const input = document.getElementById("package-search") as HTMLInputElement;
		const fromSelect = document.getElementById(
			"from-version",
		) as HTMLSelectElement;
		const toSelect = document.getElementById("to-version") as HTMLSelectElement;
		const compareBtn = document.getElementById(
			"compare-btn",
		) as HTMLButtonElement;

		if (!input || !fromSelect || !toSelect || !compareBtn) return;

		function updateCompareButton() {
			compareBtn.disabled =
				!input.value || !fromSelect.value || !toSelect.value;
		}

		function getUrlState() {
			return parseUrl(window.location.pathname);
		}

		// Compare button handler
		compareBtn.addEventListener(
			"click",
			() => {
				const state = getUrlState();
				window.dispatchEvent(
					new CustomEvent("start-diff", {
						detail: {
							registry: state.registry,
							pkg: input.value,
							from: fromSelect.value,
							to: toSelect.value,
						},
					}),
				);
			},
			{ signal },
		);

		// Prefetch on hover
		compareBtn.addEventListener(
			"mouseenter",
			() => {
				if (compareBtn.disabled) return;
				const state = getUrlState();
				window.dispatchEvent(
					new CustomEvent("prefetch-diff", {
						detail: {
							registry: state.registry,
							pkg: input.value,
							from: fromSelect.value,
							to: toSelect.value,
						},
					}),
				);
			},
			{ signal },
		);

		// Update button state on changes
		window.addEventListener("package-selected", updateCompareButton, {
			signal,
		});
		window.addEventListener("package-reset", updateCompareButton, { signal });
		window.addEventListener("versions-loaded", updateCompareButton, { signal });
		window.addEventListener("version-changed", updateCompareButton, { signal });

		// Initialization - handle URL state on load
		const initialState = getUrlState();
		if (initialState.package) {
			input.value = initialState.package;

			// Trigger package selection which will load versions
			window.dispatchEvent(
				new CustomEvent("package-selected", {
					detail: { name: initialState.package },
				}),
			);

			// After versions are loaded, trigger diff if all params present
			window.addEventListener(
				"versions-loaded",
				() => {
					const state = getUrlState();
					if (state.package && state.from && state.to) {
						window.dispatchEvent(
							new CustomEvent("start-diff", {
								detail: {
									registry: state.registry,
									pkg: state.package,
									from: state.from,
									to: state.to,
								},
							}),
						);
					}
				},
				{ once: true, signal },
			);
		}
	}

	initHeader();
	document.addEventListener("astro:page-load", initHeader);
</script>
