---
// Component for version dropdowns
---

<div class="flex-1 relative group">
	<label for="from-version" class="absolute -top-5 text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1">
		From Version
	</label>
	<div class="relative">
		<input
				id="from-version"
				type="text"
				disabled
				autocomplete="off"
				class="w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white disabled:bg-neutral-50 dark:disabled:bg-neutral-950 disabled:text-neutral-500 dark:disabled:text-neutral-600"
				placeholder="Select version"
		/>
		<div id="from-results" class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto hidden">
		</div>
	</div>
</div>

<div class="flex-1 relative group">
	<label for="to-version" class="absolute -top-5 text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1">
		To Version
	</label>
	<div class="relative">
		<input
				id="to-version"
				type="text"
				disabled
				autocomplete="off"
				class="w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white disabled:bg-neutral-50 dark:disabled:bg-neutral-950 disabled:text-neutral-500 dark:disabled:text-neutral-600"
				placeholder="Select version"
		/>
		<div id="to-results" class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto hidden">
		</div>
	</div>
</div>

<script>
	import { fetchVersions, getRegistry } from '../../registries/searchService.ts';

	const fromInput = document.getElementById('from-version') as HTMLInputElement;
	const toInput = document.getElementById('to-version') as HTMLInputElement;
	const fromResults = document.getElementById('from-results') as HTMLDivElement;
	const toResults = document.getElementById('to-results') as HTMLDivElement;

	let allVersions: string[] = [];
	let fromSelectedIndex = -1;
	let toSelectedIndex = -1;

	function renderDropdown(container: HTMLDivElement, versions: string[], _: HTMLInputElement) {
		if (versions.length === 0) {
			container.classList.add('hidden');
			return;
		}

		container.innerHTML = versions.map((v, i) => `
			<div class="version-item px-4 py-2 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors text-sm text-neutral-900 dark:text-white" data-version="${v}" data-index="${i}">
				${v}
			</div>
		`).join('');
		container.classList.remove('hidden');
	}

	function filterVersions(query: string) {
		return allVersions.filter(v => v.toLowerCase().includes(query.toLowerCase()));
	}

	function selectVersion(input: HTMLInputElement, version: string, container: HTMLDivElement) {
		input.value = version;
		container.classList.add('hidden');

		const packageInput = document.getElementById('package-search') as HTMLInputElement;
		updateUrl(packageInput.value, fromInput.value, toInput.value);
		window.dispatchEvent(new CustomEvent('version-changed'));
	}

	function getUrlState() {
		const pathParts = window.location.pathname.split('/').filter(Boolean);
		if (pathParts.length === 0) return { register: '', package: '', from: '', to: '' };

		const register = pathParts[0];
		let pkg: string;
		let from: string;
		let to: string;

		if (pathParts[1]?.startsWith('@')) {
			pkg = `${pathParts[1]}/${pathParts[2]}`;
			from = pathParts[3] || '';
			to = pathParts[4] || '';
		} else {
			pkg = pathParts[1] || '';
			from = pathParts[2] || '';
			to = pathParts[3] || '';
		}

		return { register, package: pkg, from, to };
	}

	function updateUrl(pkg: string, from: string, to: string) {
		const registry = getRegistry();
		const newPath = `/${registry}/${pkg}/${from}/${to}`;
		if (window.location.pathname !== newPath) {
			window.history.pushState({}, '', newPath);
		}
	}

	async function loadVersions(packageName: string) {
		fromInput.disabled = true;
		toInput.disabled = true;
		fromInput.placeholder = 'Loading...';
		toInput.placeholder = 'Loading...';

		try {
			allVersions = await fetchVersions(packageName);

			const state = getUrlState();
			if (state.from && allVersions.includes(state.from)) {
				fromInput.value = state.from;
			} else if (allVersions.length >= 2) {
				fromInput.value = allVersions[1];
			} else if (allVersions.length >= 1) {
				fromInput.value = allVersions[0];
			}

			if (state.to && allVersions.includes(state.to)) {
				toInput.value = state.to;
			} else if (allVersions.length >= 1) {
				toInput.value = allVersions[0];
			}

			window.dispatchEvent(new CustomEvent('versions-loaded', {
				detail: { packageName, from: fromInput.value, to: toInput.value }
			}));

			updateUrl(packageName, fromInput.value, toInput.value);

		} catch (e) {
			console.error(e);
			fromInput.placeholder = 'Error';
			toInput.placeholder = 'Error';
		} finally {
			fromInput.disabled = false;
			toInput.disabled = false;
			fromInput.placeholder = 'Select version';
			toInput.placeholder = 'Select version';
		}
	}

	// Setup listeners for both inputs
	[
		{ input: fromInput, results: fromResults, getIndex: () => fromSelectedIndex, setIndex: (i: number) => fromSelectedIndex = i },
		{ input: toInput, results: toResults, getIndex: () => toSelectedIndex, setIndex: (i: number) => toSelectedIndex = i }
	].forEach(({ input, results, getIndex, setIndex }) => {
		input?.addEventListener('focus', () => {
			renderDropdown(results, allVersions, input);
			setIndex(-1);
		});

		input?.addEventListener('input', (e) => {
			const query = (e.target as HTMLInputElement).value;
			const filtered = filterVersions(query);
			renderDropdown(results, filtered, input);
			setIndex(-1);
		});

		results?.addEventListener('click', (e) => {
			const item = (e.target as HTMLElement).closest('.version-item') as HTMLElement;
			if (item) {
				const version = item.dataset.version;
				if (version) selectVersion(input, version, results);
			}
		});

		input?.addEventListener('keydown', (e) => {
			if (results.classList.contains('hidden')) {
				if (e.key === 'ArrowDown') {
					renderDropdown(results, allVersions, input);
				}
				return;
			}

			const items = results.querySelectorAll('.version-item');
			if (!items.length) return;

			if (e.key === 'ArrowDown') {
				e.preventDefault();
				setIndex((getIndex() + 1) % items.length);
				updateHighlight(items, getIndex());
			} else if (e.key === 'ArrowUp') {
				e.preventDefault();
				setIndex((getIndex() - 1 + items.length) % items.length);
				updateHighlight(items, getIndex());
			} else if (e.key === 'Enter') {
				e.preventDefault();
				if (getIndex() >= 0) {
					const version = (items[getIndex()] as HTMLElement).dataset.version;
					if (version) selectVersion(input, version, results);
				}
			} else if (e.key === 'Escape') {
				results.classList.add('hidden');
			}
		});
	});

	function updateHighlight(items: NodeListOf<Element>, selectedIndex: number) {
		items.forEach((item, i) => {
			item.classList.toggle('bg-blue-50', i === selectedIndex);
			item.classList.toggle('dark:bg-neutral-800', i === selectedIndex);
		});
		if (selectedIndex >= 0) {
			items[selectedIndex].scrollIntoView({ block: 'nearest' });
		}
	}

	// Close dropdowns on click outside
	document.addEventListener('click', (e) => {
		if (!fromInput.contains(e.target as Node) && !fromResults.contains(e.target as Node)) {
			fromResults.classList.add('hidden');
		}
		if (!toInput.contains(e.target as Node) && !toResults.contains(e.target as Node)) {
			toResults.classList.add('hidden');
		}
	});

	// Listen for package selection
	window.addEventListener('package-selected', (e: Event) => {
		const detail = (e as CustomEvent).detail;
		loadVersions(detail.name);
	});
</script>