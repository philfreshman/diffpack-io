---
import DownloadIcon from "../Icons/DownloadIcon.astro";
// Component for version dropdowns
---

<div class="flex-1 relative group">
	<div class="absolute -top-5 left-0 flex items-center gap-2">
		<label
			for="from-version"
			class="text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1"
		>
			From Version
		</label>
		<a
			id="from-download"
			class="mb-1 hidden text-neutral-400 hover:text-neutral-700 dark:text-neutral-500 dark:hover:text-neutral-300 transition-colors"
			aria-label="Download From Version package"
			title="Download package"
			rel="noopener noreferrer"
		>
			<DownloadIcon class="w-4 h-4" />
		</a>
	</div>
	<div class="relative">
		<input
			id="from-version"
			type="text"
			disabled
			autocomplete="off"
			class="w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white disabled:bg-neutral-50 dark:disabled:bg-neutral-950 disabled:text-neutral-500 dark:disabled:text-neutral-600"
			placeholder="Select version"
		>
		<div
			id="from-results"
			class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto hidden"
		></div>
	</div>
</div>

<div class="flex-1 relative group">
	<div class="absolute -top-5 left-0 flex items-center gap-2">
		<label
			for="to-version"
			class="text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1"
		>
			To Version
		</label>
		<a
			id="to-download"
			class="mb-1 hidden text-neutral-400 hover:text-neutral-700 dark:text-neutral-500 dark:hover:text-neutral-300 transition-colors"
			aria-label="Download To Version package"
			title="Download package"
			rel="noopener noreferrer"
		>
			<DownloadIcon class="w-4 h-4" />
		</a>
	</div>
	<div class="relative">
		<input
			id="to-version"
			type="text"
			disabled
			autocomplete="off"
			class="w-full px-3 py-2 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white disabled:bg-neutral-50 dark:disabled:bg-neutral-950 disabled:text-neutral-500 dark:disabled:text-neutral-600"
			placeholder="Select version"
		>
		<div
			id="to-results"
			class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden max-h-60 overflow-y-auto hidden"
		></div>
	</div>
</div>

<script>
	import {
		buildDownloadUrl,
		fetchVersions,
		getRegistry,
	} from "../../registries/searchService.ts";
	import { escapeHTML } from "../../utils/dom.ts";
	import { parseUrl } from "../../utils/urlParser";

	let abortController: AbortController | null = null;

	function initVersionSelectors() {
		if (abortController) abortController.abort();
		abortController = new AbortController();
		const { signal } = abortController;

		const fromInput = document.getElementById(
			"from-version",
		) as HTMLInputElement;
		const toInput = document.getElementById("to-version") as HTMLInputElement;
		const fromResults = document.getElementById(
			"from-results",
		) as HTMLDivElement;
		const toResults = document.getElementById("to-results") as HTMLDivElement;
		const fromDownload = document.getElementById(
			"from-download",
		) as HTMLAnchorElement;
		const toDownload = document.getElementById(
			"to-download",
		) as HTMLAnchorElement;

		if (
			!fromInput ||
			!toInput ||
			!fromResults ||
			!toResults ||
			!fromDownload ||
			!toDownload
		)
			return;

		let allVersions: string[] = [];
		let fromSelectedIndex = -1;
		let toSelectedIndex = -1;

		function renderDropdown(
			container: HTMLDivElement,
			versions: string[],
			_: HTMLInputElement,
		) {
			if (versions.length === 0) {
				container.classList.add("hidden");
				return;
			}

			container.innerHTML = versions
				.map((v, i) => {
					const escapedVersion = escapeHTML(v);
					return `
			<div class="version-item px-4 py-2 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors text-sm text-neutral-900 dark:text-white" data-version="${escapedVersion}" data-index="${i}">
				${escapedVersion}
			</div>
		`;
				})
				.join("");
			container.classList.remove("hidden");
		}

		function filterVersions(query: string) {
			return allVersions.filter((v) =>
				v.toLowerCase().includes(query.toLowerCase()),
			);
		}

		function selectVersion(
			input: HTMLInputElement,
			version: string,
			container: HTMLDivElement,
		) {
			input.value = version;
			container.classList.add("hidden");

			const packageInput = document.getElementById(
				"package-search",
			) as HTMLInputElement;
			updateUrl(packageInput.value, fromInput.value, toInput.value);
			updateDownloadLinks();
			window.dispatchEvent(new CustomEvent("version-changed"));
		}

		function getUrlState() {
			return parseUrl(window.location.pathname);
		}

		function updateUrl(pkg: string, from: string, to: string) {
			const registry = getRegistry();
			const state = parseUrl(window.location.pathname);
			const file = state.package === pkg ? state.file : "";
			const pathParts = [registry, pkg, from, to, file].filter(Boolean);
			const newPath = `/${pathParts.join("/")}`;
			if (window.location.pathname !== newPath) {
				window.history.pushState({}, "", newPath);
			}
		}

		function resetVersions() {
			allVersions = [];
			fromSelectedIndex = -1;
			toSelectedIndex = -1;
			fromInput.value = "";
			toInput.value = "";
			fromInput.disabled = true;
			toInput.disabled = true;
			fromInput.placeholder = "Select version";
			toInput.placeholder = "Select version";
			fromResults.classList.add("hidden");
			toResults.classList.add("hidden");
			updateUrl("", "", "");
			updateDownloadLinks();
			window.dispatchEvent(new CustomEvent("version-changed"));
		}

		function updateDownloadLinks() {
			const packageInput = document.getElementById(
				"package-search",
			) as HTMLInputElement;
			const packageName = packageInput?.value?.trim() || "";
			const fromUrl = buildDownloadUrl(packageName, fromInput.value);
			const toUrl = buildDownloadUrl(packageName, toInput.value);

			fromDownload.href = fromUrl || "#";
			toDownload.href = toUrl || "#";
			fromDownload.classList.toggle("hidden", !fromUrl);
			toDownload.classList.toggle("hidden", !toUrl);
			fromDownload.setAttribute("aria-disabled", fromUrl ? "false" : "true");
			toDownload.setAttribute("aria-disabled", toUrl ? "false" : "true");
			fromDownload.tabIndex = fromUrl ? 0 : -1;
			toDownload.tabIndex = toUrl ? 0 : -1;
		}

		async function loadVersions(packageName: string) {
			fromInput.disabled = true;
			toInput.disabled = true;
			fromInput.placeholder = "Loading...";
			toInput.placeholder = "Loading...";

			try {
				allVersions = await fetchVersions(packageName);

				const state = getUrlState();
				if (state.from && allVersions.includes(state.from)) {
					fromInput.value = state.from;
				} else if (allVersions.length >= 2) {
					fromInput.value = allVersions[1];
				} else if (allVersions.length >= 1) {
					fromInput.value = allVersions[0];
				}

				if (state.to && allVersions.includes(state.to)) {
					toInput.value = state.to;
				} else if (allVersions.length >= 1) {
					toInput.value = allVersions[0];
				}

				window.dispatchEvent(
					new CustomEvent("versions-loaded", {
						detail: { packageName, from: fromInput.value, to: toInput.value },
					}),
				);

				updateUrl(packageName, fromInput.value, toInput.value);
				updateDownloadLinks();
			} catch (e) {
				console.error(e);
				fromInput.placeholder = "Error";
				toInput.placeholder = "Error";
			} finally {
				fromInput.disabled = false;
				toInput.disabled = false;
				fromInput.placeholder = "Select version";
				toInput.placeholder = "Select version";
			}
		}

		// Setup listeners for both inputs
		[
			{
				input: fromInput,
				results: fromResults,
				getIndex: () => fromSelectedIndex,
				setIndex: (i: number) => {
					fromSelectedIndex = i;
				},
			},
			{
				input: toInput,
				results: toResults,
				getIndex: () => toSelectedIndex,
				setIndex: (i: number) => {
					toSelectedIndex = i;
				},
			},
		].forEach(({ input, results, getIndex, setIndex }) => {
			input?.addEventListener(
				"focus",
				() => {
					renderDropdown(results, allVersions, input);
					setIndex(-1);
				},
				{ signal },
			);

			input?.addEventListener(
				"input",
				(e) => {
					const query = (e.target as HTMLInputElement).value;
					const filtered = filterVersions(query);
					renderDropdown(results, filtered, input);
					setIndex(-1);
				},
				{ signal },
			);

			results?.addEventListener(
				"click",
				(e) => {
					const item = (e.target as HTMLElement).closest(
						".version-item",
					) as HTMLElement;
					if (item) {
						const version = item.dataset.version;
						if (version) selectVersion(input, version, results);
					}
				},
				{ signal },
			);

			input?.addEventListener(
				"keydown",
				(e) => {
					if (results.classList.contains("hidden")) {
						if (e.key === "ArrowDown") {
							renderDropdown(results, allVersions, input);
						}
						return;
					}

					const items = results.querySelectorAll(".version-item");
					if (!items.length) return;

					if (e.key === "ArrowDown") {
						e.preventDefault();
						setIndex((getIndex() + 1) % items.length);
						updateHighlight(items, getIndex());
					} else if (e.key === "ArrowUp") {
						e.preventDefault();
						setIndex((getIndex() - 1 + items.length) % items.length);
						updateHighlight(items, getIndex());
					} else if (e.key === "Enter") {
						e.preventDefault();
						if (getIndex() >= 0) {
							const version = (items[getIndex()] as HTMLElement).dataset
								.version;
							if (version) selectVersion(input, version, results);
						}
					} else if (e.key === "Escape") {
						results.classList.add("hidden");
					}
				},
				{ signal },
			);
		});

		function updateHighlight(
			items: NodeListOf<Element>,
			selectedIndex: number,
		) {
			items.forEach((item, i) => {
				item.classList.toggle("bg-blue-50", i === selectedIndex);
				item.classList.toggle("dark:bg-neutral-800", i === selectedIndex);
			});
			if (selectedIndex >= 0) {
				items[selectedIndex].scrollIntoView({ block: "nearest" });
			}
		}

		// Close dropdowns on click outside
		document.addEventListener(
			"click",
			(e) => {
				if (
					!fromInput.contains(e.target as Node) &&
					!fromResults.contains(e.target as Node)
				) {
					fromResults.classList.add("hidden");
				}
				if (
					!toInput.contains(e.target as Node) &&
					!toResults.contains(e.target as Node)
				) {
					toResults.classList.add("hidden");
				}
			},
			{ signal },
		);

		// Listen for package selection
		window.addEventListener(
			"package-selected",
			(e: Event) => {
				const detail = (e as CustomEvent).detail;
				loadVersions(detail.name);
			},
			{ signal },
		);

		window.addEventListener("package-reset", resetVersions, { signal });
	}

	initVersionSelectors();
	document.addEventListener("astro:page-load", initVersionSelectors);
</script>
