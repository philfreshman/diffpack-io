---
import SearchInput from "./SearchInput.astro";
import SearchResults from "./SearchResults.astro";

const { registry } = Astro.props;
---

<div class="flex-2 relative" data-registry={registry}>
	<SearchInput registry={registry} />
	<SearchResults />
</div>

<script>
	import {
		getHistory,
		saveToHistory,
	} from "../../registries/historyService.ts";
	import { searchPackages } from "../../registries/searchService.ts";
	import type { SearchResult } from "../../registries/types.ts";
	import { escapeHTML } from "../../utils/dom.ts";

	let abortController: AbortController | null = null;

	function initPackageSearch() {
		if (abortController) abortController.abort();
		abortController = new AbortController();
		const { signal } = abortController;

		const input = document.getElementById("package-search") as HTMLInputElement;
		const resultsDropdown = document.getElementById("search-results");
		const resultsList = document.getElementById("search-results-list");
		const loadingIcon = document.getElementById("search-loading");
		const searchIcon = document.getElementById("search-icon");
		const resetButton = document.getElementById("search-reset");
		const registry =
			(document.querySelector("[data-registry]") as HTMLElement)?.dataset
				.registry || "npm";

		if (!input) return;

		let searchTimeout: ReturnType<typeof setTimeout>;
		let currentResults: SearchResult[] = [];
		let selectedIndex = -1;
		let selectedPackage: string | null = null;
		let isLoading = false;

		function updateActionIcon() {
			if (isLoading) {
				loadingIcon?.classList.remove("hidden");
				searchIcon?.classList.add("hidden");
				resetButton?.classList.add("hidden");
				return;
			}

			loadingIcon?.classList.add("hidden");
			const showReset = Boolean(selectedPackage);
			resetButton?.classList.toggle("hidden", !showReset);
			searchIcon?.classList.toggle("hidden", showReset);
		}

		function showLoading(show: boolean) {
			isLoading = show;
			updateActionIcon();
		}

		function renderResults(results: SearchResult[]) {
			if (!resultsDropdown || !resultsList) return;
			if (results.length === 0) {
				hideResults();
				return;
			}

			resultsList.innerHTML = results
				.map((r, i) => {
					const name = escapeHTML(r.name);
					const description = r.description ? escapeHTML(r.description) : "";
					return `
            <div class="search-item px-4 py-2.5 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors" data-index="${i}" data-name="${name}">
                <div class="font-medium text-sm text-neutral-900 dark:text-white">${name}</div>
                ${description ? `<p class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5 truncate">${description}</p>` : ""}
            </div>
        `;
				})
				.join("");

			resultsDropdown.classList.remove("hidden");
			selectedIndex = -1;
			resultsList.scrollTop = 0;
		}

		function hideResults() {
			resultsDropdown?.classList.add("hidden");
		}

		function selectPackage(name: string) {
			input.value = name;
			selectedPackage = name;
			updateActionIcon();
			hideResults();

			const pkg = currentResults.find((r) => r.name === name);
			if (pkg) {
				saveToHistory(registry, pkg);
			}

			window.dispatchEvent(
				new CustomEvent("package-selected", { detail: { name, pkg } }),
			);
		}

		function resetSearch() {
			selectedPackage = null;
			currentResults = [];
			input.value = "";
			hideResults();
			updateActionIcon();
			window.dispatchEvent(new CustomEvent("package-reset"));
			input.focus();
			const history = getHistory(registry);
			if (history.length > 0) {
				currentResults = history;
				renderResults(history);
			}
		}

		// Search input handler
		input.addEventListener(
			"input",
			(e) => {
				const query = (e.target as HTMLInputElement).value;
				clearTimeout(searchTimeout);
				if (selectedPackage && query !== selectedPackage) {
					selectedPackage = null;
					updateActionIcon();
				}
				if (query.length === 0) {
					const history = getHistory(registry);
					if (history.length > 0) {
						currentResults = history;
						renderResults(history);
					} else {
						hideResults();
					}
					return;
				}
				if (query.length < 2) {
					hideResults();
					return;
				}

				searchTimeout = setTimeout(async () => {
					showLoading(true);
					try {
						currentResults = await searchPackages(query);
						renderResults(currentResults);
					} catch (e) {
						console.error(e);
					} finally {
						showLoading(false);
					}
				}, 300);
			},
			{ signal },
		);

		input.addEventListener(
			"focus",
			() => {
				if (input.value.length === 0) {
					const history = getHistory(registry);
					if (history.length > 0) {
						currentResults = history;
						renderResults(history);
					}
				} else if (currentResults.length > 0) {
					renderResults(currentResults);
				}
			},
			{ signal },
		);

		input.addEventListener(
			"blur",
			() => {
				// Small delay to allow click events on dropdown items to fire first
				setTimeout(() => {
					hideResults();
				}, 100);
			},
			{ signal },
		);

		resetButton?.addEventListener("click", resetSearch, { signal });

		// Click handler
		resultsList?.addEventListener(
			"click",
			(e) => {
				const item = (e.target as HTMLElement).closest(
					".search-item",
				) as HTMLElement;
				if (item) {
					const name = item.dataset.name;
					if (name) selectPackage(name);
				}
			},
			{ signal },
		);

		// Keyboard navigation
		input.addEventListener(
			"keydown",
			(e) => {
				const isHidden = resultsDropdown?.classList.contains("hidden");
				if (e.key === "Enter" && isHidden) {
					if (input.value.trim()) {
						selectPackage(input.value.trim());
					}
					return;
				}

				if (isHidden && e.key === "ArrowDown" && input.value.length === 0) {
					const history = getHistory(registry);
					if (history.length > 0) {
						currentResults = history;
						renderResults(history);
						return;
					}
				}

				if (isHidden) return;

				const items = resultsList?.querySelectorAll(".search-item");
				if (!items?.length) return;

				if (e.key === "ArrowDown") {
					e.preventDefault();
					selectedIndex = (selectedIndex + 1) % items.length;
					updateHighlight(items);
				} else if (e.key === "ArrowUp") {
					e.preventDefault();
					selectedIndex = (selectedIndex - 1 + items.length) % items.length;
					updateHighlight(items);
				} else if (e.key === "Enter") {
					e.preventDefault();
					if (selectedIndex >= 0) {
						const name = (items[selectedIndex] as HTMLElement).dataset.name;
						if (name) selectPackage(name);
					} else if (input.value.trim()) {
						selectPackage(input.value.trim());
					}
				} else if (e.key === "Escape") {
					hideResults();
				}
			},
			{ signal },
		);

		function updateHighlight(items: NodeListOf<Element>) {
			items.forEach((item, i) => {
				item.classList.toggle("bg-blue-50", i === selectedIndex);
				item.classList.toggle("dark:bg-neutral-800", i === selectedIndex);
			});
		}

		window.addEventListener(
			"package-selected",
			(e: Event) => {
				const detail = (e as CustomEvent).detail;
				if (detail?.name) {
					selectedPackage = detail.name;
					if (detail.pkg) {
						saveToHistory(registry, detail.pkg);
					}
					updateActionIcon();
				}
			},
			{ signal },
		);

		if (input.value) {
			selectedPackage = input.value;
			updateActionIcon();
		} else {
			updateActionIcon();
		}
	}

	initPackageSearch();
	document.addEventListener("astro:page-load", initPackageSearch);
</script>
