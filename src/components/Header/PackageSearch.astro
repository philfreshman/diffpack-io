---
import SearchIcon from "../Icons/SearchIcon.astro";

const { registry } = Astro.props;
---

<div class="flex-2 relative">
	<label
		for="package-search"
		class="absolute -top-5 text-xs font-medium text-neutral-700 dark:text-neutral-300 mb-1"
	>
		Package Name
	</label>
	<div class="relative">
		<input
			id="package-search"
			type="text"
			value=""
			placeholder={`Search ${registry || 'package'}s...`}
			autocomplete="off"
			class="w-full px-4 py-2 pr-10 bg-white dark:bg-neutral-900 border border-neutral-300 dark:border-neutral-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm text-neutral-900 dark:text-white placeholder-neutral-400 dark:placeholder-neutral-500"
		>
		<div
			id="search-loading"
			class="absolute right-3 top-1/2 -translate-y-1/2 hidden"
		>
			<div
				class="animate-spin rounded-full h-4 w-4 border-2 border-blue-500 border-t-transparent"
			></div>
		</div>
		<div id="search-icon" class="absolute right-3 top-1/2 -translate-y-1/2">
			<SearchIcon class="w-4 h-4 text-neutral-400 dark:text-neutral-500"/>
		</div>

		<!-- Search Results Dropdown -->
		<div
			id="search-results"
			class="absolute z-50 w-full mt-1 bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-lg overflow-hidden max-h-80 overflow-y-auto hidden"
		></div>
	</div>
</div>

<script>
	import { searchPackages } from "../../registries/searchService.ts";
	import type { SearchResult } from "../../registries/types.ts";
	import { escapeHTML } from "../../utils/dom.ts";

	let abortController: AbortController | null = null;

	function initPackageSearch() {
		if (abortController) abortController.abort();
		abortController = new AbortController();
		const { signal } = abortController;

		const input = document.getElementById("package-search") as HTMLInputElement;
		const resultsDropdown = document.getElementById("search-results");
		const loadingIcon = document.getElementById("search-loading");
		const searchIcon = document.getElementById("search-icon");

		if (!input) return;

		let searchTimeout: ReturnType<typeof setTimeout>;
		let currentResults: SearchResult[] = [];
		let selectedIndex = -1;

		function showLoading(show: boolean) {
			loadingIcon?.classList.toggle("hidden", !show);
			searchIcon?.classList.toggle("hidden", show);
		}

		function renderResults(results: SearchResult[]) {
			if (!resultsDropdown) return;
			if (results.length === 0) {
				hideResults();
				return;
			}

			resultsDropdown.innerHTML = results
				.map((r, i) => {
					const name = escapeHTML(r.name);
					const description = r.description ? escapeHTML(r.description) : "";
					return `
            <div class="search-item px-4 py-2.5 cursor-pointer hover:bg-neutral-50 dark:hover:bg-neutral-700 transition-colors" data-index="${i}" data-name="${name}">
                <div class="font-medium text-sm text-neutral-900 dark:text-white">${name}</div>
                ${description ? `<p class="text-xs text-neutral-600 dark:text-neutral-400 mt-0.5 truncate">${description}</p>` : ""}
            </div>
        `;
				})
				.join("");
			resultsDropdown.classList.remove("hidden");
			selectedIndex = -1;
		}

		function hideResults() {
			resultsDropdown?.classList.add("hidden");
		}

		function selectPackage(name: string) {
			input.value = name;
			hideResults();
			window.dispatchEvent(
				new CustomEvent("package-selected", { detail: { name } }),
			);
		}

		// Search input handler
		input.addEventListener(
			"input",
			(e) => {
				const query = (e.target as HTMLInputElement).value;
				clearTimeout(searchTimeout);
				if (query.length < 2) {
					hideResults();
					return;
				}

				searchTimeout = setTimeout(async () => {
					showLoading(true);
					try {
						currentResults = await searchPackages(query);
						renderResults(currentResults);
					} catch (e) {
						console.error(e);
					} finally {
						showLoading(false);
					}
				}, 300);
			},
			{ signal },
		);

		// Click handler
		resultsDropdown?.addEventListener(
			"click",
			(e) => {
				const item = (e.target as HTMLElement).closest(
					".search-item",
				) as HTMLElement;
				if (item) {
					const name = item.dataset.name;
					if (name) selectPackage(name);
				}
			},
			{ signal },
		);

		// Keyboard navigation
		input.addEventListener(
			"keydown",
			(e) => {
				if (resultsDropdown?.classList.contains("hidden")) return;

				const items = resultsDropdown?.querySelectorAll(".search-item");
				if (!items?.length) return;

				if (e.key === "ArrowDown") {
					e.preventDefault();
					selectedIndex = (selectedIndex + 1) % items.length;
					updateHighlight(items);
				} else if (e.key === "ArrowUp") {
					e.preventDefault();
					selectedIndex = (selectedIndex - 1 + items.length) % items.length;
					updateHighlight(items);
				} else if (e.key === "Enter") {
					e.preventDefault();
					if (selectedIndex >= 0) {
						const name = (items[selectedIndex] as HTMLElement).dataset.name;
						if (name) selectPackage(name);
					}
				} else if (e.key === "Escape") {
					hideResults();
				}
			},
			{ signal },
		);

		function updateHighlight(items: NodeListOf<Element>) {
			items.forEach((item, i) => {
				item.classList.toggle("bg-blue-50", i === selectedIndex);
				item.classList.toggle("dark:bg-neutral-800", i === selectedIndex);
			});
		}

		// Close dropdown on click outside
		document.addEventListener(
			"click",
			(e) => {
				if (
					!input?.contains(e.target as Node) &&
					!resultsDropdown?.contains(e.target as Node)
				) {
					hideResults();
				}
			},
			{ signal },
		);
	}

	initPackageSearch();
	document.addEventListener("astro:page-load", initPackageSearch);
</script>
