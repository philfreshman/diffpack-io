---
import DiffArea from "./DiffArea.astro";
import Toolbar from "./Toolbar.astro";
---

<div class="flex flex-col h-full">
	<Toolbar/>
	<DiffArea/>
</div>

<script>
	import Prism from "prismjs";
	import "prismjs/themes/prism.css";
	import "prismjs/plugins/diff-highlight/prism-diff-highlight.css";
	import "prismjs/plugins/autolinker/prism-autolinker.css";
	import "prismjs/components/prism-markup";
	import "prismjs/components/prism-json";
	import "prismjs/components/prism-javascript";
	import "prismjs/components/prism-typescript";
	import "prismjs/components/prism-jsx";
	import "prismjs/components/prism-tsx";
	import "prismjs/components/prism-css";
	import "prismjs/components/prism-scss";
	import "prismjs/components/prism-less";
	import "prismjs/components/prism-bash";
	import "prismjs/components/prism-markdown";
	import "prismjs/components/prism-diff";
	import "prismjs/components/prism-yaml";
	import "prismjs/components/prism-toml";
	import "prismjs/components/prism-rust";
	import "prismjs/plugins/diff-highlight/prism-diff-highlight";
	import "prismjs/plugins/autolinker/prism-autolinker";

	const diffContainer = document.getElementById("diff-container");
	const diffFilename = document.getElementById("diff-filename");
	const diffContent = document.getElementById("diff-content");
	const languageBadge = document.getElementById("language-badge");

	function resetDiff() {
		diffContainer?.classList.add("hidden");
		if (diffFilename) diffFilename.textContent = "";
		if (diffContent) diffContent.innerHTML = "";
		if (languageBadge) {
			languageBadge.textContent = "";
			languageBadge.classList.add("hidden");
		}
	}

	function getLanguageFromFilename(filename: string) {
		const ext = filename.split(".").pop()?.toLowerCase();
		switch (ext) {
			case "js":
			case "mjs":
			case "cjs":
				return "javascript";
			case "jsx":
				return "jsx";
			case "ts":
			case "mts":
				return "typescript";
			case "tsx":
				return "tsx";
			case "json":
				return "json";
			case "md":
				return "markdown";
			case "sh":
				return "bash";
			case "yml":
			case "yaml":
				return "yaml";
			case "toml":
				return "toml";
			case "rs":
				return "rust";
			case "css":
				return "css";
			case "scss":
				return "scss";
			case "less":
				return "less";
			case "html":
			case "htm":
				return "markup";
			case "vue":
				return "markup";
			case "svelte":
				return "markup";
			case "astro":
				return "markup";
			default:
				return "clike";
		}
	}

	function showDiff(filename: string, diff: string, isDiff = true) {
		if (!diffContainer || !diffFilename || !diffContent) return;
		diffContainer.classList.remove("hidden");
		diffFilename.textContent = filename;

		const lang = isDiff ? "diff" : getLanguageFromFilename(filename);
		const prismLang = Prism.languages[lang] || Prism.languages.clike;

		if (languageBadge) {
			languageBadge.textContent = lang;
			languageBadge.classList.remove("hidden");
		}

		diffContent.innerHTML = "";

		if (isDiff) {
			const lines = diff.split("\n");
			let oldLineNum = 0;
			let newLineNum = 0;

			lines.forEach((line) => {
				if (
					line.startsWith("diff ") ||
					line.startsWith("index ") ||
					line.startsWith("--- ") ||
					line.startsWith("+++ ")
				)
					return;

				const row = document.createElement("div");
				row.className = "diff-row";

				const oldNumCell = document.createElement("div");
				oldNumCell.className = "diff-line-number";
				const newNumCell = document.createElement("div");
				newNumCell.className = "diff-line-number";
				const contentCell = document.createElement("div");
				contentCell.className = "diff-line-content";

				if (line.startsWith("@@")) {
					const match = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
					if (match) {
						oldLineNum = parseInt(match[1], 10) - 1;
						newLineNum = parseInt(match[2], 10) - 1;
					}
					row.classList.add("diff-row-hunk");
					oldNumCell.textContent = "...";
					newNumCell.textContent = "...";
				} else if (line.startsWith("-")) {
					oldLineNum++;
					oldNumCell.textContent = oldLineNum.toString();
					newNumCell.textContent = "";
					row.classList.add("diff-row-deleted");
				} else if (line.startsWith("+")) {
					newLineNum++;
					oldNumCell.textContent = "";
					newNumCell.textContent = newLineNum.toString();
					row.classList.add("diff-row-added");
				} else {
					oldLineNum++;
					newLineNum++;
					oldNumCell.textContent = oldLineNum.toString();
					newNumCell.textContent = newLineNum.toString();
				}

				contentCell.innerHTML = Prism.highlight(
					line,
					Prism.languages.diff,
					"diff",
				);
				row.appendChild(oldNumCell);
				row.appendChild(newNumCell);
				row.appendChild(contentCell);
				diffContent.appendChild(row);
			});
		} else {
			const lines = diff.split("\n");

			lines.forEach((line, index) => {
				const row = document.createElement("div");
				row.className = "diff-row";

				const oldNumCell = document.createElement("div");
				oldNumCell.className = "diff-line-number";
				const newNumCell = document.createElement("div");
				newNumCell.className = "diff-line-number";
				const contentCell = document.createElement("div");
				contentCell.className = "diff-line-content";

				const lineNum = (index + 1).toString();
				oldNumCell.textContent = lineNum;
				newNumCell.textContent = lineNum;

				contentCell.innerHTML = Prism.highlight(line || " ", prismLang, lang);
				row.appendChild(oldNumCell);
				row.appendChild(newNumCell);
				row.appendChild(contentCell);
				diffContent.appendChild(row);
			});
		}
	}

	interface FileDiffDetail {
		filename: string;
		diff: string;
		isDiff: boolean;
	}

	window.addEventListener("start-diff", resetDiff);
	window.addEventListener("file-diff", (e) => {
		const customEvent = e as CustomEvent<FileDiffDetail>;
		const detail = customEvent.detail;
		if (detail?.filename && detail.diff !== undefined) {
			showDiff(detail.filename, detail.diff, detail.isDiff);
		}
	});
</script>
