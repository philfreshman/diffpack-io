---
import DiffArea from "./DiffArea.astro";
import ExpandAllContentButton from "./ExpandAllContentButton.astro";
import ExpandButton from "./ExpandButton.astro";
import Toolbar from "./Toolbar.astro";
---

<div class="flex flex-col h-full">
	<Toolbar />
	<DiffArea />
</div>

<template id="expand-up-tpl">
	<ExpandButton direction="up" title="" />
</template>

<template id="expand-down-tpl">
	<ExpandButton direction="down" title="" />
</template>

<template id="expand-all-content-tpl">
	<ExpandAllContentButton />
</template>

<script>
	import Prism from "prismjs";
	import "prismjs/themes/prism.css";
	import "prismjs/plugins/diff-highlight/prism-diff-highlight.css";
	import "prismjs/plugins/autolinker/prism-autolinker.css";
	import "prismjs/components/prism-markup";
	import "prismjs/components/prism-json";
	import "prismjs/components/prism-javascript";
	import "prismjs/components/prism-typescript";
	import "prismjs/components/prism-jsx";
	import "prismjs/components/prism-tsx";
	import "prismjs/components/prism-css";
	import "prismjs/components/prism-scss";
	import "prismjs/components/prism-less";
	import "prismjs/components/prism-bash";
	import "prismjs/components/prism-markdown";
	import "prismjs/components/prism-diff";
	import "prismjs/components/prism-yaml";
	import "prismjs/components/prism-toml";
	import "prismjs/components/prism-rust";
	import "prismjs/plugins/diff-highlight/prism-diff-highlight";
	import "prismjs/plugins/autolinker/prism-autolinker";

	let diffContainer = document.getElementById("diff-container");
	let diffFilename = document.getElementById("diff-filename");
	let diffContent = document.getElementById("diff-content");
	let languageBadge = document.getElementById("language-badge");
	let scrollbarTrack = document.getElementById("scrollbar-track");
	let scrollbarThumb = document.getElementById("scrollbar-thumb");
	let scrollbarMarkers = document.getElementById("scrollbar-markers");

	const scrollPositions = new Map<string, number>();
	let currentFilename = "";
	let scrollbarHideTimeout: ReturnType<typeof setTimeout> | null = null;
	let isDragging = false;
	let isHoveringTrack = false;

	function showScrollbar() {
		if (!scrollbarTrack || !diffContent) return;
		if (diffContent.scrollHeight <= diffContent.clientHeight) return;

		if (scrollbarHideTimeout) {
			clearTimeout(scrollbarHideTimeout);
			scrollbarHideTimeout = null;
		}
		scrollbarTrack.classList.remove("opacity-0");
		scrollbarTrack.classList.add("opacity-100");
	}

	function hideScrollbarWithDelay() {
		if (scrollbarHideTimeout) {
			clearTimeout(scrollbarHideTimeout);
		}
		scrollbarHideTimeout = setTimeout(() => {
			if (!scrollbarTrack || isDragging || isHoveringTrack) return;
			scrollbarTrack.classList.remove("opacity-100");
			scrollbarTrack.classList.add("opacity-0");
			scrollbarHideTimeout = null;
		}, 600);
	}

	function initFileViewer() {
		if (scrollbarHideTimeout) {
			clearTimeout(scrollbarHideTimeout);
			scrollbarHideTimeout = null;
		}
		diffContainer = document.getElementById("diff-container");
		diffFilename = document.getElementById("diff-filename");
		diffContent = document.getElementById("diff-content");
		languageBadge = document.getElementById("language-badge");
		scrollbarTrack = document.getElementById("scrollbar-track");
		scrollbarThumb = document.getElementById("scrollbar-thumb");
		scrollbarMarkers = document.getElementById("scrollbar-markers");

		if (diffContent) {
			diffContent.addEventListener("scroll", () => {
				updateScrollbarThumb();
				showScrollbar();
				hideScrollbarWithDelay();
			});
		}
		if (scrollbarTrack) {
			scrollbarTrack.addEventListener("mousedown", onScrollbarMouseDown);
			scrollbarTrack.addEventListener("mouseenter", () => {
				isHoveringTrack = true;
				showScrollbar();
			});
			scrollbarTrack.addEventListener("mouseleave", () => {
				isHoveringTrack = false;
				hideScrollbarWithDelay();
			});
		}
	}

	initFileViewer();
	document.addEventListener("astro:page-load", initFileViewer);

	interface DiffLine {
		type: "added" | "deleted" | "unchanged" | "hunk";
		line: string;
		oldNum: number | null;
		newNum: number | null;
		forceVisible?: boolean;
	}

	let currentProcessedLines: DiffLine[] = [];
	let currentIsDiff = false;
	let currentPrismLang: Prism.Grammar = Prism.languages.clike;
	let currentLang = "";

	const CLASSES = {
		row: "flex leading-6 whitespace-pre-wrap break-all",
		rowDeleted: "bg-[#ffeef0] dark:bg-[#442d30]",
		rowAdded: "bg-[#e6ffec] dark:bg-[#233329]",
		rowHunk:
			"bg-[#f1f8ff] text-neutral-500 dark:bg-[#1e2836] dark:text-neutral-400",
		rowCollapsed:
			"bg-neutral-50 text-neutral-500 cursor-default dark:bg-[#0d1117] dark:text-neutral-400",
		lineNumber:
			"w-[var(--line-number-width)] min-w-[var(--line-number-width)] flex-shrink-0 px-2 text-right text-neutral-400 select-none border-r border-neutral-100 dark:text-neutral-500  dark:border-[#30363d]",
		lineNumberDeleted:
			"bg-[#ffdce0] border-r-[#fdaeb7] dark:bg-[#61222a] dark:border-r-[#6e363b]",
		lineNumberAdded:
			"bg-[#cdffd8] border-r-[#bef5cb] dark:bg-[#1a3a2a] dark:border-r-[#2b4b3b]",
		lineNumberHunk:
			"bg-[#dbedff] border-r-[#c8e1ff] dark:bg-[#263449] dark:border-r-[#38444d]",
		lineNumberCollapsed:
			"bg-[#dbedff] border-r-[#c8e1ff] flex flex-col items-center justify-center p-0 gap-0 w-[calc(2*var(--line-number-width))] min-w-[calc(2*var(--line-number-width))] flex-shrink-0 dark:bg-[#263449] dark:border-r-[#38444d]",
		content:
			"px-3 flex-1 [&_.token.deleted]:bg-transparent [&_.token.deleted]:no-underline [&_.token.inserted]:bg-transparent",
		contentCollapsed:
			"flex items-center bg-[#f1f8ff] text-neutral-500 italic h-10 dark:bg-[#1e2836] dark:text-neutral-400",
	};

	function updateScrollbarThumb() {
		if (!diffContent || !scrollbarThumb || !scrollbarTrack) return;
		const scrollHeight = diffContent.scrollHeight;
		const clientHeight = diffContent.clientHeight;
		const scrollTop = diffContent.scrollTop;

		if (scrollHeight <= clientHeight) {
			scrollbarThumb.style.display = "none";
			scrollbarTrack.classList.remove("opacity-100");
			scrollbarTrack.classList.add("opacity-0");
			return;
		}

		scrollbarThumb.style.display = "block";
		const thumbHeight = Math.max(
			20,
			(clientHeight / scrollHeight) * clientHeight,
		);
		const maxScrollTop = scrollHeight - clientHeight;
		const maxThumbTop = clientHeight - thumbHeight;
		const thumbTop = (scrollTop / maxScrollTop) * maxThumbTop;

		scrollbarThumb.style.height = `${thumbHeight}px`;
		scrollbarThumb.style.top = `${thumbTop}px`;
	}

	let startY = 0;
	let startScrollTop = 0;

	function onScrollbarMouseDown(e: MouseEvent) {
		if (!diffContent || !scrollbarThumb || !scrollbarTrack) return;
		const content = diffContent;

		if (e.target === scrollbarThumb) {
			isDragging = true;
			startY = e.clientY;
			startScrollTop = content.scrollTop;
			document.addEventListener("mousemove", onScrollbarMouseMove);
			document.addEventListener("mouseup", onScrollbarMouseUp);
			e.preventDefault();
		} else {
			const rect = scrollbarTrack.getBoundingClientRect();
			const clickPos = e.clientY - rect.top;
			const thumbHeight = scrollbarThumb.offsetHeight;
			const clientHeight = content.clientHeight;
			const scrollHeight = content.scrollHeight;

			const targetScrollTop =
				((clickPos - thumbHeight / 2) / (clientHeight - thumbHeight)) *
				(scrollHeight - clientHeight);
			content.scrollTop = targetScrollTop;
		}
	}

	function onScrollbarMouseMove(e: MouseEvent) {
		if (!isDragging || !diffContent || !scrollbarThumb || !scrollbarTrack)
			return;
		const content = diffContent;

		const deltaY = e.clientY - startY;
		const clientHeight = content.clientHeight;
		const scrollHeight = content.scrollHeight;
		const thumbHeight = scrollbarThumb.offsetHeight;

		const scrollDelta =
			(deltaY / (clientHeight - thumbHeight)) * (scrollHeight - clientHeight);
		content.scrollTop = startScrollTop + scrollDelta;
	}

	function onScrollbarMouseUp() {
		isDragging = false;
		document.removeEventListener("mousemove", onScrollbarMouseMove);
		document.removeEventListener("mouseup", onScrollbarMouseUp);
		hideScrollbarWithDelay();
	}

	function renderMarkers() {
		if (!scrollbarMarkers || !diffContent || !scrollbarTrack) return;
		const content = diffContent;
		scrollbarMarkers.innerHTML = "";

		const scrollHeight = content.scrollHeight;
		const trackHeight = scrollbarTrack.clientHeight;

		if (scrollHeight <= 0) return;

		const contentRect = content.getBoundingClientRect();
		const rows = content.querySelectorAll(
			'[data-type="added"], [data-type="deleted"]',
		);
		const fragment = document.createDocumentFragment();

		rows.forEach((row) => {
			const htmlRow = row as HTMLElement;
			const rowRect = htmlRow.getBoundingClientRect();
			const top = rowRect.top - contentRect.top + content.scrollTop;
			const height = rowRect.height;

			const markerTop = (top / scrollHeight) * trackHeight;
			const markerHeight = Math.max(1, (height / scrollHeight) * trackHeight);

			const marker = document.createElement("div");
			marker.className = "absolute left-0 w-full";
			marker.style.top = `${markerTop}px`;
			marker.style.height = `${markerHeight}px`;

			if (htmlRow.dataset.type === "added") {
				marker.classList.add("bg-[#e6ffec]", "dark:bg-[#233329]");
			} else {
				marker.classList.add("bg-[#ffeef0]", "dark:bg-[#442d30]");
			}

			fragment.appendChild(marker);
		});

		scrollbarMarkers.appendChild(fragment);
	}

	function resetDiff() {
		scrollPositions.clear();
		currentFilename = "";
		diffContainer?.classList.add("hidden");
		if (diffFilename) diffFilename.textContent = "";
		if (diffContent) diffContent.innerHTML = "";
		if (languageBadge) {
			languageBadge.textContent = "";
			languageBadge.classList.add("hidden");
		}
		if (scrollbarMarkers) scrollbarMarkers.innerHTML = "";
		updateScrollbarThumb();
	}

	function getLanguageFromFilename(filename: string) {
		const ext = filename.split(".").pop()?.toLowerCase();
		switch (ext) {
			case "js":
			case "mjs":
			case "cjs":
				return "javascript";
			case "jsx":
				return "jsx";
			case "ts":
			case "mts":
				return "typescript";
			case "tsx":
				return "tsx";
			case "json":
				return "json";
			case "md":
				return "markdown";
			case "sh":
				return "bash";
			case "yml":
			case "yaml":
				return "yaml";
			case "toml":
				return "toml";
			case "rs":
				return "rust";
			case "css":
				return "css";
			case "scss":
				return "scss";
			case "less":
				return "less";
			case "html":
			case "htm":
				return "markup";
			case "vue":
				return "markup";
			case "svelte":
				return "markup";
			case "astro":
				return "markup";
			default:
				return "clike";
		}
	}

	function showDiff(filename: string, diff: string, isDiff = true) {
		if (!diffContainer || !diffFilename || !diffContent) return;

		scrollPositions.set(currentFilename, diffContent.scrollTop);
		currentFilename = filename;

		diffContainer.classList.remove("hidden");
		diffFilename.textContent = filename;

		currentIsDiff = isDiff;
		currentLang = isDiff ? "diff" : getLanguageFromFilename(filename);
		currentPrismLang =
			(Prism.languages[currentLang] as Prism.Grammar) || Prism.languages.clike;

		if (languageBadge) {
			languageBadge.textContent = currentLang;
			languageBadge.classList.remove("hidden");
		}

		currentProcessedLines = [];
		const lines = diff.split("\n");

		if (isDiff) {
			let oldLineNum = 0;
			let newLineNum = 0;

			lines.forEach((line) => {
				if (
					line.startsWith("diff ") ||
					line.startsWith("index ") ||
					line.startsWith("--- ") ||
					line.startsWith("+++ ")
				)
					return;

				let type: DiffLine["type"];
				let oldNum: number | null = null;
				let newNum: number | null = null;

				if (line.startsWith("@@")) {
					const match = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
					if (match) {
						oldLineNum = parseInt(match[1], 10) - 1;
						newLineNum = parseInt(match[2], 10) - 1;
					}
					type = "hunk";
				} else if (line.startsWith("-")) {
					oldLineNum++;
					oldNum = oldLineNum;
					type = "deleted";
				} else if (line.startsWith("+")) {
					newLineNum++;
					newNum = newLineNum;
					type = "added";
				} else {
					oldLineNum++;
					newLineNum++;
					oldNum = oldLineNum;
					newNum = newLineNum;
					type = "unchanged";
				}

				currentProcessedLines.push({ type, line, oldNum, newNum });
			});
		} else {
			lines.forEach((line, index) => {
				const lineNum = index + 1;
				currentProcessedLines.push({
					type: "unchanged",
					line,
					oldNum: lineNum,
					newNum: lineNum,
				});
			});
		}

		let maxLineNum = 0;
		for (const l of currentProcessedLines) {
			if (l.oldNum && l.oldNum > maxLineNum) maxLineNum = l.oldNum;
			if (l.newNum && l.newNum > maxLineNum) maxLineNum = l.newNum;
		}
		const chars = Math.max(maxLineNum.toString().length, 3);
		if (diffContent) {
			diffContent.style.setProperty(
				"--line-number-width",
				`calc(${chars + 1}ch + 0.6rem)`,
			);
		}

		renderDiffContent();

		if (diffContent) {
			const content = diffContent;
			if (scrollPositions.has(filename)) {
				content.scrollTop = scrollPositions.get(filename)!;
			} else {
				content.scrollTop = 0;
			}
		}
	}

	function renderDiffContent(expandAll = false) {
		if (!diffContent) return;
		diffContent.innerHTML = "";

		const CONTEXT_LINES = 3;
		const isVisible = new Array(currentProcessedLines.length).fill(false);

		if (expandAll || !currentIsDiff) {
			isVisible.fill(true);
		} else {
			currentProcessedLines.forEach((line, i) => {
				if (line.type !== "unchanged" || line.forceVisible) {
					isVisible[i] = true;
					if (line.type !== "hunk") {
						for (let j = 1; j <= CONTEXT_LINES; j++) {
							if (i - j >= 0) isVisible[i - j] = true;
							if (i + j < currentProcessedLines.length) isVisible[i + j] = true;
						}
					}
				}
			});
		}

		for (let i = 0; i < currentProcessedLines.length; i++) {
			if (isVisible[i]) {
				const line = currentProcessedLines[i];
				const row = createDiffRow(line);
				diffContent.appendChild(row);
			} else {
				const start = i;
				while (i < currentProcessedLines.length && !isVisible[i]) {
					i++;
				}
				const end = i - 1;
				const collapsedRow = createCollapsedRow(start, end);
				diffContent.appendChild(collapsedRow);
				i--;
			}
		}

		updateScrollbarThumb();
		renderMarkers();
	}

	function createDiffRow(lineObj: DiffLine) {
		const { type, line, oldNum, newNum } = lineObj;
		const row = document.createElement("div");
		row.className = CLASSES.row;
		row.dataset.type = type;

		const oldNumCell = document.createElement("div");
		oldNumCell.className = CLASSES.lineNumber;
		const newNumCell = document.createElement("div");
		newNumCell.className = CLASSES.lineNumber;
		const contentCell = document.createElement("div");
		contentCell.className = CLASSES.content;

		if (type === "hunk") {
			row.className += ` ${CLASSES.rowHunk}`;
			oldNumCell.className += ` ${CLASSES.lineNumberHunk}`;
			newNumCell.className += ` ${CLASSES.lineNumberHunk}`;
			oldNumCell.textContent = "...";
			newNumCell.textContent = "...";
		} else if (type === "deleted") {
			oldNumCell.textContent = oldNum?.toString() || "";
			newNumCell.textContent = "";
			row.className += ` ${CLASSES.rowDeleted}`;
			oldNumCell.className += ` ${CLASSES.lineNumberDeleted}`;
		} else if (type === "added") {
			oldNumCell.textContent = "";
			newNumCell.textContent = newNum?.toString() || "";
			row.className += ` ${CLASSES.rowAdded}`;
			newNumCell.className += ` ${CLASSES.lineNumberAdded}`;
		} else {
			oldNumCell.textContent = oldNum?.toString() || "";
			newNumCell.textContent = newNum?.toString() || "";
		}

		contentCell.innerHTML = Prism.highlight(
			line || " ",
			currentIsDiff
				? Prism.languages.diff
				: (currentPrismLang as Prism.Grammar),
			currentLang,
		);
		row.appendChild(oldNumCell);
		row.appendChild(newNumCell);
		row.appendChild(contentCell);
		return row;
	}

	function createCollapsedRow(start: number, end: number) {
		const row = document.createElement("div");
		row.className = `${CLASSES.row} ${CLASSES.rowCollapsed}`;

		const expanderCell = document.createElement("div");
		expanderCell.className = CLASSES.lineNumberCollapsed;
		const contentCell = document.createElement("div");
		contentCell.className = `${CLASSES.content} ${CLASSES.contentCollapsed}`;

		const count = end - start + 1;
		contentCell.textContent = `@@ Collapsed ${count} lines @@`;

		const createBtn = (
			direction: "up" | "down",
			title: string,
			onClick: (e: MouseEvent) => void,
		) => {
			const template = document.getElementById(
				`expand-${direction}-tpl`,
			) as HTMLTemplateElement;
			const clone = template.content.cloneNode(true) as DocumentFragment;
			const btn = clone.firstElementChild as HTMLElement;
			btn.title = title;
			btn.onclick = (e) => {
				e.stopPropagation();
				onClick(e);
			};
			return btn;
		};

		const onExpandDown = () => {
			for (let i = start; i < Math.min(start + 20, end + 1); i++) {
				currentProcessedLines[i].forceVisible = true;
			}
			renderDiffContent();
		};

		const onExpandUp = () => {
			for (let i = Math.max(start, end - 19); i <= end; i++) {
				currentProcessedLines[i].forceVisible = true;
			}
			renderDiffContent();
		};

		const onExpandAll = () => {
			for (let i = start; i <= end; i++) {
				currentProcessedLines[i].forceVisible = true;
			}
			renderDiffContent();
		};

		if (start === 0) {
			expanderCell.appendChild(createBtn("up", "Expand all", onExpandAll));
		} else if (end === currentProcessedLines.length - 1) {
			expanderCell.appendChild(createBtn("down", "Expand all", onExpandAll));
		} else {
			expanderCell.appendChild(createBtn("down", "Expand down", onExpandDown));
			expanderCell.appendChild(createBtn("up", "Expand up", onExpandUp));

			// Add expand all to content cell as well for convenience
			const template = document.getElementById(
				"expand-all-content-tpl",
			) as HTMLTemplateElement;
			const clone = template.content.cloneNode(true) as DocumentFragment;
			const expandAllBtn = clone.querySelector("span") as HTMLElement;
			expandAllBtn.onclick = onExpandAll;
			contentCell.prepend(expandAllBtn);
		}

		row.appendChild(expanderCell);
		row.appendChild(contentCell);
		return row;
	}

	interface FileDiffDetail {
		filename: string;
		diff: string;
		isDiff: boolean;
	}

	window.addEventListener("start-diff", resetDiff);
	window.addEventListener("expand-all-diff", () => {
		renderDiffContent(true);
	});
	window.addEventListener("file-diff", (e) => {
		const customEvent = e as CustomEvent<FileDiffDetail>;
		const detail = customEvent.detail;
		if (detail?.filename && detail.diff !== undefined) {
			showDiff(detail.filename, detail.diff, detail.isDiff);
		}
	});

	window.addEventListener("resize", () => {
		updateScrollbarThumb();
		renderMarkers();
	});
</script>
